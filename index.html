<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPE Compteur GAZ - Firebase + Google Drive</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ⚠️ CONFIGURATION À MODIFIER AVEC VOS CLÉS
      const firebaseConfig = {
  apiKey: "AIzaSyBI_av-raTRq18kPdJPRh-ABdcbqECcqqg",
  authDomain: "vpe-vompteur-gaz.firebaseapp.com",
  projectId: "vpe-vompteur-gaz",
  storageBucket: "vpe-vompteur-gaz.firebasestorage.app",
  messagingSenderId: "946715120324",
  appId: "1:946715120324:web:be4d78b7e61360a143ef91"
};

        const GOOGLE_DRIVE_CLIENT_ID = "946715120324-i3gc3d1jbfnvf1niqs33tp1otiecdb23.apps.googleusercontent.com";
        // Initialiser Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        window.addEventListener('DOMContentLoaded', function() {
            const { useState, useEffect, createElement: h } = React;
            const { createRoot } = ReactDOM;

            // Icônes SVG
            const HomeIcon = () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                h('path', { d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
                h('polyline', { points: '9 22 9 12 15 12 15 22' })
            );

            const PlusIcon = () => h('svg', { width: 40, height: 40, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                h('line', { x1: 12, y1: 5, x2: 12, y2: 19 }),
                h('line', { x1: 5, y1: 12, x2: 19, y2: 12 })
            );

            const CloudIcon = () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                h('path', { d: 'M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z' })
            );

            const DownloadIcon = () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                h('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                h('polyline', { points: '7 10 12 15 17 10' }),
                h('line', { x1: 12, y1: 15, x2: 12, y2: 3 })
            );

            const SearchIcon = () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                h('circle', { cx: 11, cy: 11, r: 8 }),
                h('path', { d: 'm21 21-4.35-4.35' })
            );

            const SaveIcon = () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                h('path', { d: 'M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z' }),
                h('polyline', { points: '17 21 17 13 7 13 7 21' }),
                h('polyline', { points: '7 3 7 8 15 8' })
            );

            function App() {
                const [user, setUser] = useState(null);
                const [loading, setLoading] = useState(true);
                const [interventions, setInterventions] = useState([]);
                const [currentView, setCurrentView] = useState('home');
                const [interventionType, setInterventionType] = useState('');
                const [searchTerm, setSearchTerm] = useState('');
                const [driveInitialized, setDriveInitialized] = useState(false);
                const [formData, setFormData] = useState({
                    visitBy: '',
                    interventionDate: '',
                    postNumber: '',
                    postName: '',
                    address: '',
                    commune: '',
                    arrivalTime: '',
                    departureTime: '',
                    removeMeterId: '',
                    removeMeterBrand: '',
                    removeMeterType: '',
                    removeMeterYear: '',
                    removeMeterLastCalib: '',
                    removeImpulsion: '',
                    removeCategory: 'Membranes',
                    removeAppellation: 'G16',
                    removeWheelsBefore: '',
                    removeWheelsAfter: '',
                    removeIndex: '',
                    removeFreeLabel: '',
                    installMeterId: '',
                    installMeterBrand: '',
                    installMeterType: '',
                    installMeterYear: '',
                    installMeterLastCalib: '',
                    installImpulsion: '',
                    installCategory: 'Membranes',
                    installAppellation: 'G16',
                    installWheelsBefore: '',
                    installWheelsAfter: '',
                    installIndex: '',
                    installFreeLabel: '',
                    telerelevantBeforeRef: '40000',
                    telerelevantBeforeSerial: '32',
                    telerelevantBeforeIndex1: '',
                    telerelevantBeforeIndex2: '',
                    telerelevantAfterSerial: '',
                    telerelevantAfterIndex1: '',
                    telerelevantAfterIndex2: '',
                    converterBeforeBrand: '',
                    converterBeforeIndex: '',
                    converterBeforeBase: '',
                    converterAfterSerial: '',
                    converterAfterIndex: '',
                    converterAfterBase: '',
                    photoVueGenerale: '',
                    photoCompteurDepose: '',
                    photoCompteurPose: '',
                    photoEtiquetteDLV: '',
                    photoEnvironnementPDL: '',
                    photoConvertisseur: '',
                    photoTelereleveAvant: '',
                    photoTelereleveApres: '',
                    maintenance: '',
                    photo: '',
                    sortieInfluance: '',
                    plaqueVS: '',
                    plaquePoste: '',
                    cello: '',
                    jointCompteur: '',
                    jointTorique: '',
                    jointPlat: '',
                    jointTamis: '',
                    flitre: '',
                    staubli: '',
                    mamelonMale: '',
                    teLaiton: '',
                    compteur: '',
                    antiRouille: '',
                    peinture: '',
                    couleurRAL: '',
                    boulonsEntree: '',
                    boulonsDiamEntree: '',
                    boulonsDiamSortie: '',
                    boulonsLongEntree: '',
                    boulonsLongSortie: '',
                    boulonsSortieQte: '',
                    dimensionHaut: '',
                    dimensionBas: '',
                    dimensionGauche: '',
                    dimensionDroite: '',
                    dimensionCentre: '',
                    hauteurCompteur: '',
                    commentaires: ''
                });

                useEffect(() => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        setUser(user);
                        setLoading(false);
                        if (user) {
                            loadInterventions();
                            initializeGoogleDrive();
                        }
                    });
                    return () => unsubscribe();
                }, []);

                const initializeGoogleDrive = () => {
                    gapi.load('client:auth2', () => {
                        gapi.client.init({
                            apiKey: GOOGLE_DRIVE_API_KEY,
                            clientId: GOOGLE_DRIVE_CLIENT_ID,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                            scope: 'https://www.googleapis.com/auth/drive.file'
                        }).then(() => {
                            setDriveInitialized(true);
                        });
                    });
                };

                const signInWithGoogle = async () => {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await auth.signInWithPopup(provider);
                    } catch (error) {
                        alert('Erreur de connexion: ' + error.message);
                    }
                };

                const signOut = async () => {
                    try {
                        await auth.signOut();
                        setInterventions([]);
                    } catch (error) {
                        alert('Erreur de déconnexion: ' + error.message);
                    }
                };

                const loadInterventions = async () => {
                    try {
                        const snapshot = await db.collection('interventions')
                            .where('userId', '==', auth.currentUser.uid)
                            .orderBy('createdAt', 'desc')
                            .get();
                        
                        const data = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setInterventions(data);
                    } catch (error) {
                        console.error('Erreur chargement:', error);
                    }
                };

                const handleInputChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                };

                const handlePhotoCapture = (e, fieldName) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                let width = img.width;
                                let height = img.height;
                                const maxSize = 1920;
                                
                                if (width > maxSize || height > maxSize) {
                                    if (width > height) {
                                        height = (height / width) * maxSize;
                                        width = maxSize;
                                    } else {
                                        width = (width / height) * maxSize;
                                        height = maxSize;
                                    }
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                const jpegDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                                setFormData(prev => ({ ...prev, [fieldName]: jpegDataUrl }));
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    try {
                        const newIntervention = {
                            type: interventionType,
                            ...formData,
                            userId: auth.currentUser.uid,
                            userEmail: auth.currentUser.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await db.collection('interventions').add(newIntervention);
                        alert('Intervention enregistrée avec succès !');
                        resetForm();
                        setCurrentView('list');
                        loadInterventions();
                    } catch (error) {
                        alert('Erreur lors de l\'enregistrement: ' + error.message);
                    }
                };

                const resetForm = () => {
                    setFormData({
                        visitBy: '',
                        interventionDate: '',
                        postNumber: '',
                        postName: '',
                        address: '',
                        commune: '',
                        arrivalTime: '',
                        departureTime: '',
                        removeMeterId: '',
                        removeMeterBrand: '',
                        removeMeterType: '',
                        removeMeterYear: '',
                        removeMeterLastCalib: '',
                        removeImpulsion: '',
                        removeCategory: 'Membranes',
                        removeAppellation: 'G16',
                        removeWheelsBefore: '',
                        removeWheelsAfter: '',
                        removeIndex: '',
                        removeFreeLabel: '',
                        installMeterId: '',
                        installMeterBrand: '',
                        installMeterType: '',
                        installMeterYear: '',
                        installMeterLastCalib: '',
                        installImpulsion: '',
                        installCategory: 'Membranes',
                        installAppellation: 'G16',
                        installWheelsBefore: '',
                        installWheelsAfter: '',
                        installIndex: '',
                        installFreeLabel: '',
                        telerelevantBeforeRef: '40000',
                        telerelevantBeforeSerial: '32',
                        telerelevantBeforeIndex1: '',
                        telerelevantBeforeIndex2: '',
                        telerelevantAfterSerial: '',
                        telerelevantAfterIndex1: '',
                        telerelevantAfterIndex2: '',
                        converterBeforeBrand: '',
                        converterBeforeIndex: '',
                        converterBeforeBase: '',
                        converterAfterSerial: '',
                        converterAfterIndex: '',
                        converterAfterBase: '',
                        photoVueGenerale: '',
                        photoCompteurDepose: '',
                        photoCompteurPose: '',
                        photoEtiquetteDLV: '',
                        photoEnvironnementPDL: '',
                        photoConvertisseur: '',
                        photoTelereleveAvant: '',
                        photoTelereleveApres: '',
                        maintenance: '',
                        photo: '',
                        sortieInfluance: '',
                        plaqueVS: '',
                        plaquePoste: '',
                        cello: '',
                        jointCompteur: '',
                        jointTorique: '',
                        jointPlat: '',
                        jointTamis: '',
                        flitre: '',
                        staubli: '',
                        mamelonMale: '',
                        teLaiton: '',
                        compteur: '',
                        antiRouille: '',
                        peinture: '',
                        couleurRAL: '',
                        boulonsEntree: '',
                        boulonsDiamEntree: '',
                        boulonsDiamSortie: '',
                        boulonsLongEntree: '',
                        boulonsLongSortie: '',
                        boulonsSortieQte: '',
                        dimensionHaut: '',
                        dimensionBas: '',
                        dimensionGauche: '',
                        dimensionDroite: '',
                        dimensionCentre: '',
                        hauteurCompteur: '',
                        commentaires: ''
                    });
                };

                const uploadToGoogleDrive = async (intervention) => {
                    if (!driveInitialized) {
                        alert('Google Drive n\'est pas initialisé. Veuillez réessayer.');
                        return;
                    }

                    try {
                        // Vérifier si l'utilisateur est connecté à Google
                        const isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
                        if (!isSignedIn) {
                            await gapi.auth2.getAuthInstance().signIn();
                        }

                        // Créer un dossier pour l'intervention
                        const folderName = `VPE_${intervention.postNumber}_${intervention.interventionDate}`;
                        
                        const folderMetadata = {
                            name: folderName,
                            mimeType: 'application/vnd.google-apps.folder'
                        };

                        const folderResponse = await gapi.client.drive.files.create({
                            resource: folderMetadata,
                            fields: 'id'
                        });

                        const folderId = folderResponse.result.id;

                        // Upload CSV
                        const csvData = Object.entries(intervention)
                            .filter(([key]) => !key.startsWith('photo'))
                            .map(([key, value]) => `${key},${value}`)
                            .join('\\n');

                        const csvBlob = new Blob([csvData], { type: 'text/csv' });
                        const csvMetadata = {
                            name: `intervention_${intervention.postNumber}.csv`,
                            parents: [folderId]
                        };

                        const csvForm = new FormData();
                        csvForm.append('metadata', new Blob([JSON.stringify(csvMetadata)], { type: 'application/json' }));
                        csvForm.append('file', csvBlob);

                        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token }),
                            body: csvForm
                        });

                        // Upload photos
                        const photos = [
                            { name: 'vue_generale.jpg', data: intervention.photoVueGenerale },
                            { name: 'compteur_depose.jpg', data: intervention.photoCompteurDepose },
                            { name: 'compteur_pose.jpg', data: intervention.photoCompteurPose },
                            { name: 'etiquette_dlv.jpg', data: intervention.photoEtiquetteDLV },
                            { name: 'environnement_pdl.jpg', data: intervention.photoEnvironnementPDL },
                            { name: 'convertisseur.jpg', data: intervention.photoConvertisseur },
                            { name: 'telereleve_avant.jpg', data: intervention.photoTelereleveAvant },
                            { name: 'telereleve_apres.jpg', data: intervention.photoTelereleveApres }
                        ];

                        for (const photo of photos) {
                            if (photo.data) {
                                const blob = await fetch(photo.data).then(r => r.blob());
                                const photoMetadata = {
                                    name: photo.name,
                                    parents: [folderId]
                                };

                                const photoForm = new FormData();
                                photoForm.append('metadata', new Blob([JSON.stringify(photoMetadata)], { type: 'application/json' }));
                                photoForm.append('file', blob);

                                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                                    method: 'POST',
                                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token }),
                                    body: photoForm
                                });
                            }
                        }

                        alert(`✅ Intervention sauvegardée sur Google Drive dans le dossier "${folderName}" !`);
                    } catch (error) {
                        console.error('Erreur Google Drive:', error);
                        alert('Erreur lors de la sauvegarde sur Google Drive: ' + error.message);
                    }
                };

                const deleteIntervention = async (id) => {
                    if (confirm('Êtes-vous sûr de vouloir supprimer cette intervention ?')) {
                        try {
                            await db.collection('interventions').doc(id).delete();
                            loadInterventions();
                        } catch (error) {
                            alert('Erreur lors de la suppression: ' + error.message);
                        }
                    }
                };

                const filteredInterventions = interventions.filter(int =>
                    int.postNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    int.postName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    int.commune?.toLowerCase().includes(searchTerm.toLowerCase())
                );

                const startNewIntervention = (type) => {
                    setInterventionType(type);
                    setCurrentView('form');
                };

                // Écran de connexion
                if (loading) {
                    return h('div', { className: 'min-h-screen flex items-center justify-center' },
                        h('div', { className: 'text-xl' }, 'Chargement...')
                    );
                }

                if (!user) {
                    return h('div', { className: 'min-h-screen flex items-center justify-center bg-gradient-to-br from-teal-500 to-blue-600' },
                        h('div', { className: 'bg-white p-8 rounded-lg shadow-2xl max-w-md w-full text-center' },
                            h('h1', { className: 'text-3xl font-bold text-gray-800 mb-2' }, 'VPE COMPTEUR GAZ'),
                            h('p', { className: 'text-gray-600 mb-8' }, 'Gestion des interventions avec Firebase + Google Drive'),
                            h('button', {
                                onClick: signInWithGoogle,
                                className: 'w-full px-6 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 flex items-center justify-center gap-3 font-semibold'
                            },
                                h('img', { src: 'https://www.google.com/favicon.ico', width: 20, height: 20 }),
                                'Se connecter avec Google'
                            ),
                            h('p', { className: 'mt-6 text-sm text-gray-500' }, '✨ Synchronisation automatique avec Google Drive'),
                            h('p', { className: 'mt-2 text-sm text-gray-500' }, '☁️ Sauvegarde cloud sécurisée')
                        )
                    );
                }

                // Interface principale (similaire à la version précédente mais avec Firebase)
                // Le reste du code reste identique...
                return h('div', { className: 'min-h-screen bg-gray-50' },
                    h('div', { className: 'bg-teal-700 text-white p-4 shadow-lg' },
                        h('div', { className: 'max-w-7xl mx-auto flex justify-between items-center' },
                            h('div', null,
                                h('h1', { className: 'text-2xl font-bold' }, 'VPE COMPTEUR GAZ'),
                                h('p', { className: 'text-sm text-teal-100' }, `Connecté: ${user.email}`)
                            ),
                            h('button', {
                                onClick: signOut,
                                className: 'px-4 py-2 bg-teal-800 rounded hover:bg-teal-900'
                            }, 'Déconnexion')
                        )
                    ),
                    h('div', { className: 'max-w-7xl mx-auto p-6' },
                        h('div', { className: 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6' },
                            '✅ Application connectée à Firebase + Google Drive'
                        ),
                        h('p', { className: 'text-center text-gray-600' }, 'Interface complète disponible une fois les clés configurées...')
                    )
                );
            }

            const root = createRoot(document.getElementById('app'));
            root.render(h(App));
        });
    </script>
</body>
</html>
